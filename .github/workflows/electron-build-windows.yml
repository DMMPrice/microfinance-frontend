name: Build & Release Electron App (Windows - EXE Only)

on:
  workflow_dispatch:
    inputs:
      bump:
        description: "Version bump type"
        required: true
        default: "patch"
        type: choice
        options:
          - patch
          - minor
          - major

permissions:
  contents: write

jobs:
  build-release-windows:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      # ✅ Auto bump VERSION + package.json + package-lock.json, commit and tag
      - name: Bump version, commit, and tag
        shell: pwsh
        run: |
          if (!(Test-Path VERSION)) { "Create VERSION file with 1.0.0 first"; exit 1 }
          if (!(Test-Path package.json)) { "package.json not found"; exit 1 }

          $bump = "${{ inputs.bump }}"
          $old = (Get-Content VERSION -Raw).Trim()

          if ($old -notmatch '^\d+\.\d+\.\d+$') { "VERSION must be like 1.0.0, got: $old"; exit 1 }

          $parts = $old.Split(".") | ForEach-Object { [int]$_ }
          $major = $parts[0]; $minor = $parts[1]; $patch = $parts[2]

          if ($bump -eq "major") { $major++; $minor=0; $patch=0 }
          elseif ($bump -eq "minor") { $minor++; $patch=0 }
          else { $patch++ }

          $new = "$major.$minor.$patch"

          # Update VERSION file
          Set-Content VERSION $new -NoNewline

          # Update package.json version (and package-lock.json)
          # This also keeps npm ci consistent.
          npm version $new --no-git-tag-version

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add VERSION package.json package-lock.json
          git commit -m "release: v$new"

          git tag "v$new"
          git push origin HEAD
          git push origin "v$new"

          "TAG=v$new" | Out-File -FilePath $env:GITHUB_ENV -Append
          "VER=$new"  | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Install dependencies
        shell: pwsh
        run: |
          npm ci

      - name: Build Windows EXE
        shell: pwsh
        run: |
          npm run build:win

      # ✅ Find the generated EXE automatically (excluding node_modules)
      - name: Locate EXE
        shell: pwsh
        run: |
          $exe = Get-ChildItem -Path . -Recurse -File -Filter *.exe |
            Where-Object { $_.FullName -notmatch "\\node_modules\\" } |
            Sort-Object Length -Descending |
            Select-Object -First 1

          if (-not $exe) { Write-Error "No EXE file found!"; exit 1 }

          Write-Host "Found EXE: $($exe.FullName)"
          "EXE_PATH=$($exe.FullName)" | Out-File -FilePath $env:GITHUB_ENV -Append

      # ✅ Create release and upload ONLY the EXE
      - name: Create GitHub Release (EXE Only)
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.TAG }}
          name: Micro Finance App ${{ env.TAG }}
          generate_release_notes: true
          files: ${{ env.EXE_PATH }}
